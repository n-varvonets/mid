
# Вопрос 9.1: Чем отличается `bulk_update` от обычного `update`? Как эффективно обновить 2 млн записей в таблице, чтобы в каждом поле изменить уникальную информацию, которая рассчитывается отдельно для каждой записи?

## Отличие `bulk_update` от обычного `update`

- **Обычный `update`** в Django (`MyModel.objects.filter(...).update(...)`) — это метод, который генерирует **один SQL-запрос** и обновляет сразу несколько строк в таблице с указанными значениями для полей. Однако, он **не вызывает** метод `save()` на объектах, и потому **сигналы** (`post_save`, `pre_save`) не срабатывают.
  
  Пример использования:
  ```python
  MyModel.objects.filter(status='pending').update(status='processed')
  ```

  - Преимущества: Генерация одного SQL-запроса делает этот метод быстрым для обновления множества строк с одинаковым значением.
  - Недостатки: Подходит только для случаев, когда нужно обновить все записи одним и тем же значением. Не вызывает сигналы.

- **`bulk_update`** — это метод, позволяющий обновить сразу несколько объектов в базе данных с **разными значениями полей** за один SQL-запрос. Для этого необходимо передать список объектов, которые были изменены, и указать, какие поля нужно обновить.

  Пример использования:
  ```python
  MyModel.objects.bulk_update([obj1, obj2, obj3], ['field1', 'field2'])
  ```

  - Преимущества: Позволяет обновлять несколько объектов с разными значениями полей за один запрос, что экономит ресурсы и повышает производительность.
  - Недостатки: Как и в случае с обычным `update`, сигналы не срабатывают.

## Как эффективно обновить 2 млн записей с уникальными значениями

Если для каждой записи требуется рассчитать уникальное значение и обновить её, то самым эффективным способом будет использовать **`bulk_update`**. Вместо того, чтобы делать миллионы отдельных запросов с вызовом метода `save()` на каждом объекте, вы можете загрузить данные в память, произвести вычисления и обновить записи **пакетами** с помощью `bulk_update`.

### Шаги:
1. Загрузите данные частями (например, по 10 000 записей).
2. Измените каждую запись с новым рассчитанным значением.
3. Используйте `bulk_update` для обновления части объектов за один запрос.
4. Повторите для следующей части записей.

### Пример:
```python
batch_size = 10000
for batch in range(0, 2000000, batch_size):
    objs = MyModel.objects.all()[batch:batch+batch_size]
    
    for obj in objs:
        # Рассчитываем новое уникальное значение для каждого объекта
        obj.field1 = calculate_new_value(obj)
    
    MyModel.objects.bulk_update(objs, ['field1'])
```

### Преимущества такого подхода:
- Обновление идёт **частями**, что предотвращает переполнение памяти.
- **`bulk_update`** минимизирует количество SQL-запросов.
- Каждый запрос обновляет **разные** значения для каждого объекта.

